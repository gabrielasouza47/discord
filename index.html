<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bate-papo estilo Discord</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    /* ===== RESET ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "gg sans", "Segoe UI", Arial, sans-serif;
      background-color: #313338;
      color: #dbdee1;
      height: 100vh;
      display: flex;
      overflow: hidden; 
    }

    /* ===== SIDEBAR ===== */
    .sidebar {
      width: 240px;
      height: 100vh; 
      background-color: rgba(43, 45, 49, 0.95); 
      backdrop-filter: blur(4px); 
      display: flex;
      flex-direction: column;
      border-right: 1px solid #1e1f22;
      
      position: absolute; 
      top: 0;
      left: -240px; /* Come√ßa escondida */
      z-index: 100; 
      transition: left 0.3s ease-in-out; 
    }
    
    .sidebar.visible {
      left: 0;
    }

    .sidebar h2 {
      text-align: center;
      font-size: 18px;
      padding: 20px 0;
      color: #fff;
      border-bottom: 1px solid #1e1f22;
    }

    .user-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .user {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      background-color: rgba(56, 58, 64, 0.8);
      border-radius: 6px;
      margin-bottom: 8px;
      color: #dbdee1;
      font-size: 14px;
      transition: 0.2s;
    }

    .user:hover {
      background-color: #404249; 
    }

    .user-photo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #202225;
      background-size: cover;
      background-position: center;
      flex-shrink: 0;
      border: 2px solid #1e1f22;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #dbdee1;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 16px;
    }
    
    .sidebar-foto-input {
      padding: 10px; 
      border-top: 1px solid #1e1f22;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .sidebar-foto-input label {
      font-size: 14px;
    }
    .sidebar-foto-input input {
      font-size: 12px;
      color: #dbdee1;
    }

    .sidebar-background-settings {
      padding: 10px;
      border-top: 1px solid #1e1f22;
    }
    .settings-button-label {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      font-size: 14px;
      color: #b9bbbe;
      transition: background-color 0.2s, color 0.2s;
    }
    .settings-button-label:hover {
      background-color: #383a40;
      color: #ffffff;
    }
    .settings-button-label svg {
      flex-shrink: 0; 
    }
    .settings-button-label:hover svg path {
      fill: #ffffff;
    }


    /* ===== MAIN CHAT AREA ===== */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
      
      background-color: #000000; 
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    
    .chat-header {
      display: flex;
      align-items: center;
      padding: 10px 15px;
      background-color: rgba(43, 45, 49, 0.9);
      backdrop-filter: blur(2px);
      border-bottom: 1px solid #1e1f22;
      flex-shrink: 0;
    }
    
    #toggleSidebarButton {
      background: none;
      border: none;
      cursor: pointer;
      padding: 6px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
    }
    #toggleSidebarButton:hover {
      background-color: #383a40;
    }
    #toggleSidebarButton svg path {
      fill: #b9bbbe;
      transition: fill 0.2s;
    }
    #toggleSidebarButton:hover svg path {
      fill: #ffffff;
    }


    /* Mensagens */
    #mensagens {
      flex: 1;
      list-style: none;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      scroll-behavior: smooth;
      
      background-color: rgba(49, 51, 56, 0.4); 
    }

    .mensagem {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      max-width: 70%;
      animation: aparecer 0.2s ease-in-out;
    }

    .mensagem.self {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .msg-foto {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      flex-shrink: 0;
      border: 2px solid #1e1f22;
    }

    .msg-conteudo {
      background-color: rgba(56, 58, 64, 0.9); 
      padding: 10px 15px;
      border-radius: 8px;
      word-wrap: break-word;
      font-size: 15px;
      line-height: 1.4;
      backdrop-filter: blur(1px); 
    }

    .self .msg-conteudo {
      background-color: rgba(88, 101, 242, 0.9); 
      color: white;
    }

    .msg-cabecalho {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
    }
    
    .msg-cabecalho span {
      font-weight: bold;
      color: #ffffff;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    
    .msg-conteudo p {
      margin: 0;
      word-wrap: break-word; 
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    .self .msg-conteudo p {
      text-shadow: none; 
    }

    .msg-imagem {
      max-width: 100%;
      max-height: 300px;
      border-radius: 6px;
      margin-top: 5px;
      cursor: pointer;
      transition: opacity 0.2s;
      border: 1px solid rgba(0,0,0,0.2); 
    }
    .msg-imagem:hover {
      opacity: 0.8;
    }

    /* ===== NOVO: Container para Hora + Status ===== */
    .msg-meta {
      display: flex;
      align-items: center;
      gap: 5px;
      float: right; /* Alinha √† direita */
      clear: both; /* Garante que fique abaixo do texto/imagem */
      margin-top: 5px;
    }

    .msg-timestamp {
      font-size: 11px;
      color: #949ba4; /* Cor padr√£o para msg recebida */
      font-weight: normal;
    }
    
    .self .msg-timestamp {
      color: #c9cfff; /* Cor para msg enviada */
    }
    
    .msg-status {
      font-size: 14px;
      color: #c9cfff; /* Cor do checkmark (‚úì) */
    }
    /* ============================================= */


    /* Formul√°rio */
    form {
      display: flex;
      padding: 15px;
      background-color: rgba(43, 45, 49, 0.9); 
      backdrop-filter: blur(2px); 
      border-top: 1px solid #1e1f22;
      gap: 10px;
      align-items: center;
      flex-shrink: 0; 
    }
    
    .attach-button {
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
    }
    .attach-button:hover {
      background-color: #383a40;
    }
    .attach-button svg path {
      fill: #b9bbbe;
    }

    .user-info-container {
      width: 25%; 
    }
    
    .user-info-display {
      display: none; 
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background-color: rgba(56, 58, 64, 0.9);
      border-radius: 6px;
      height: 40.5px; 
      box-sizing: border-box; 
    }
    
    .online-dot {
      width: 10px;
      height: 10px;
      background-color: #3ba55d; 
      border-radius: 50%;
      flex-shrink: 0;
      border: 1px solid #2b2d31;
    }
    
    #userNameDisplay {
      color: #dbdee1;
      font-weight: 500;
      font-size: 15px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }


    #nome,
    #mensagem {
      background-color: rgba(56, 58, 64, 0.9); 
      color: #dbdee1;
      border: none;
      padding: 10px 12px;
      border-radius: 6px;
      outline: none;
      font-size: 15px;
    }

    #nome {
      width: 100%; 
    }

    #mensagem {
      flex: 1;
    }
    
    #imagePreviewContainer {
      display: none; 
      align-items: center;
      gap: 10px;
      background: rgba(43, 45, 49, 0.9); 
      padding: 8px 15px;
      border-top: 1px solid #1e1f22;
      font-size: 14px;
      flex-shrink: 0; 
    }
    #previewFileName {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #949ba4;
    }
    #removeImageButton {
      background: #ed4245;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      cursor: pointer;
      font-weight: bold;
      line-height: 20px;
      text-align: center;
    }

    button {
      background-color: #5865f2;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover {
      background-color: #4752c4;
    }

    /* Rolagem custom */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-thumb {
      background-color: #202225;
      border-radius: 10px;
    }
    
    #overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 99; 
    }
    
    body.sidebar-visible #overlay {
      display: block;
    }

    @keyframes aparecer {
      from {
        opacity: 0;
        transform: translateY(4px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body>
  <div class="sidebar" id="sidebar">
    <h2>Usu√°rios Online</h2>
    <div class="user-list" id="userList"></div>
    
    <div class="sidebar-foto-input">
      <label for="foto">Sua foto de perfil:</label>
      <input id="foto" type="file" accept="image/*" />
    </div>
    
    <div class="sidebar-background-settings">
      <label for="backgroundInput" class="settings-button-label">
        <svg aria-hidden="true" role="img" width="20" height="20" viewBox="0 0 24 24">
          <path fill="#b9bbbe" d="M19.438 10.438C19.78 11.231 20 12.091 20 13C20 14.337 19.625 15.563 18.998 16.568L20.443 17.741C20.732 17.973 20.77 18.391 20.539 18.68C20.308 18.969 19.89 19.007 19.599 18.776L17.89 17.382C17.169 17.923 16.326 18.32 15.405 18.525V20.5C15.405 20.887 15.092 21.2 14.705 21.2H11.295C10.908 21.2 10.595 20.887 10.595 20.5V18.525C9.674 18.32 8.831 17.923 8.11 17.382L6.401 18.776C6.11 19.007 5.692 18.969 5.461 18.68C5.23 18.391 5.268 17.973 5.557 17.741L7.002 16.568C6.375 15.563 6 14.337 6 13C6 12.091 6.22 11.231 6.562 10.438L4.22 9.479C3.908 9.335 3.732 8.992 3.826 8.665C3.92 8.338 4.237 8.11 4.57 8.21L7.14 8.855C7.942 8.001 8.961 7.375 10.09 7.09V5.5C10.09 5.113 10.403 4.8 10.79 4.8H14.21C14.597 4.8 14.91 5.113 14.91 5.5V7.09C16.039 7.375 17.058 8.001 17.86 8.855L20.43 8.21C20.763 8.11 21.08 8.338 21.174 8.665C21.268 8.992 21.092 9.335 20.78 9.479L19.438 10.438ZM13 15.5C14.381 15.5 15.5 14.381 15.5 13C15.5 11.619 14.381 10.5 13 10.5C11.619 10.5 10.5 11.619 10.5 13C10.5 14.381 11.619 15.5 13 15.5Z"></path>
        </svg>
        <span>Mudar plano de fundo</span>
      </label>
      <input type="file" id="backgroundInput" accept="image/*" style="display: none;" />
    </div>
    
  </div>

  <div class="chat-container" id="chatContainer"> 
    <div class="chat-header">
      <button id="toggleSidebarButton" title="Mostrar/Esconder Menu">
        <svg aria-hidden="true" role="img" width="24" height="24" viewBox="0 0 24 24">
          <path fill="#b9bbbe" d="M3 18H21V16H3V18ZM3 13H21V11H3V13ZM3 6V8H21V6H3Z"></path>
        </svg>
      </button>
    </div>
  
    <ul id="mensagens"></ul>
    
    <div id="imagePreviewContainer">
      <span id="previewFileName"></span>
      <button id="removeImageButton" title="Remover imagem">X</button>
    </div>

    <form id="form">
      <label for="imageInput" class="attach-button" title="Anexar imagem">
        <svg aria-hidden="true" role="img" width="24" height="24" viewBox="0 0 24 24">
          <path fill="#b9bbbe" d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM17 13H13V17H11V13H7V11H11V7H13V11H17V13Z"></path>
        </svg>
      </label>
      <input type="file" id="imageInput" accept="image/*" style="display: none;" />

      <div class="user-info-container">
        <input id="nome" placeholder="Seu nome" autocomplete="off" />
        <div id="userInfoDisplay" class="user-info-display">
            <div class="online-dot"></div>
            <span id="userNameDisplay"></span>
        </div>
      </div>
      
      <input id="mensagem" placeholder="Escreva uma mensagem..." autocomplete="off" />
      <button>Enviar</button>
    </form>
  </div>

  <div id="overlay"></div>

  <audio id="notificationSound" src="notification-sound-effect-372475.mp3" preload="auto"></audio>

  <script>
    const socket = io();

    // Elementos do DOM
    const nomeInput = document.getElementById("nome");
    const fotoInput = document.getElementById("foto");
    const mensagemInput = document.getElementById("mensagem");
    const mensagens = document.getElementById("mensagens");
    const form = document.getElementById("form");
    const userList = document.getElementById("userList");

    // Elementos para envio de imagem e som
    const imageInput = document.getElementById("imageInput");
    const imagePreviewContainer = document.getElementById("imagePreviewContainer");
    const previewFileName = document.getElementById("previewFileName");
    const removeImageButton = document.getElementById("removeImageButton");
    const notificationSound = document.getElementById("notificationSound");
    
    // Elementos para o fundo
    const chatContainer = document.getElementById("chatContainer");
    const backgroundInput = document.getElementById("backgroundInput");
    
    // Elementos para display do nome
    const userInfoDisplay = document.getElementById("userInfoDisplay");
    const userNameDisplay = document.getElementById("userNameDisplay");
    
    // Elementos da Sidebar
    const body = document.body;
    const sidebar = document.getElementById("sidebar");
    const toggleSidebarButton = document.getElementById("toggleSidebarButton");
    const overlay = document.getElementById("overlay");

    let nomeUsuario = "";
    let fotoUsuario = null;
    let imagemAnexada = null; 
    
    // Fun√ß√µes para abrir/fechar sidebar
    function abrirSidebar() {
      sidebar.classList.add("visible");
      body.classList.add("sidebar-visible");
    }
    
    function fecharSidebar() {
      sidebar.classList.remove("visible");
      body.classList.remove("sidebar-visible");
    }
    
    toggleSidebarButton.addEventListener("click", (e) => {
      e.stopPropagation(); 
      if (sidebar.classList.contains("visible")) {
        fecharSidebar();
      } else {
        abrirSidebar();
      }
    });
    
    overlay.addEventListener("click", fecharSidebar);

    // üîπ L√™ a foto de PERFIL e converte em Base64
    fotoInput.addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          fotoUsuario = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });
    
    // üîπ L√™ a imagem de FUNDO e aplica no chat
    backgroundInput.addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (file) {
        const imageURL = URL.createObjectURL(file);
        chatContainer.style.backgroundImage = `url('${imageURL}')`;
      }
    });

    // üîπ L√™ a imagem da MENSAGEM e converte em Base64
    imageInput.addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          imagemAnexada = e.target.result;
          previewFileName.textContent = file.name; 
          imagePreviewContainer.style.display = "flex"; 
        };
        reader.readAsDataURL(file);
      }
    });
    
    // üîπ Remove a imagem anexada
    removeImageButton.addEventListener("click", () => {
      imagemAnexada = null;
      imageInput.value = null; 
      imagePreviewContainer.style.display = "none"; 
    });


    // üîπ Envia mensagem
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      
      if (!nomeUsuario) {
        const nome = nomeInput.value.trim();
        if (!nome) return; 
        
        nomeUsuario = nome; 
        
        nomeInput.style.display = "none"; 
        userNameDisplay.textContent = nome; 
        userInfoDisplay.style.display = "flex"; 
        
        fotoInput.disabled = true; 
      }
      
      const mensagem = mensagemInput.value.trim();

      if (!mensagem && !imagemAnexada) return;

      socket.emit("chat message", { 
        nome: nomeUsuario, 
        mensagem, 
        foto: fotoUsuario,
        timestamp: new Date().toISOString(), 
        imagem: imagemAnexada 
      });
      
      mensagemInput.value = "";
      removeImageButton.click(); 
    });

    // üîπ Recebe mensagens
    socket.on("chat message", (dados) => {
      const li = document.createElement("li");
      li.classList.add("mensagem");
      if (dados.nome === nomeUsuario) li.classList.add("self");

      const fotoDiv = document.createElement("div");
      fotoDiv.classList.add("msg-foto");
      if (dados.foto) {
        fotoDiv.style.backgroundImage = `url('${dados.foto}')`;
      } else {
        fotoDiv.textContent = dados.nome.charAt(0).toUpperCase();
      }

      const conteudo = document.createElement("div");
      conteudo.classList.add("msg-conteudo");
      
      const cabecalho = document.createElement("div");
      cabecalho.classList.add("msg-cabecalho");
      
      const nomeSpan = document.createElement("span");
      nomeSpan.textContent = dados.nome;
      
      // NOVO: Criamos o timeSpan aqui, mas s√≥ o adicionamos no final
      const timeSpan = document.createElement("span");
      timeSpan.classList.add("msg-timestamp");
      const data = new Date(dados.timestamp);
      timeSpan.textContent = data.toLocaleTimeString('pt-BR', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });

      cabecalho.appendChild(nomeSpan);
      // Removido: cabecalho.appendChild(timeSpan);
      conteudo.appendChild(cabecalho); 

      if (dados.mensagem) {
        const textoP = document.createElement("p");
        textoP.textContent = dados.mensagem;
        conteudo.appendChild(textoP);
      }
      
      if (dados.imagem) {
        const img = document.createElement("img");
        img.src = dados.imagem;
        img.classList.add("msg-imagem");
        img.alt = "Imagem enviada";
        img.onclick = () => window.open(dados.imagem, '_blank');
        conteudo.appendChild(img);
      }
      
      // ===== NOVO: Adiciona Meta (Hora + Status) =====
      const metaDiv = document.createElement("div");
      metaDiv.classList.add("msg-meta");
      
      // Adiciona o Hor√°rio
      metaDiv.appendChild(timeSpan);
      
      // Adiciona Status (‚úì) APENAS se for sua pr√≥pria msg
      if (dados.nome === nomeUsuario) {
        const statusSpan = document.createElement("span");
        statusSpan.classList.add("msg-status");
        statusSpan.textContent = "‚úì"; // Um check = Enviado
        metaDiv.appendChild(statusSpan);
      }
      
      // Adiciona o container de metadados ao conte√∫do
      conteudo.appendChild(metaDiv);
      // ===============================================

      li.appendChild(fotoDiv);
      li.appendChild(conteudo);
      mensagens.appendChild(li);
      mensagens.scrollTop = mensagens.scrollHeight;
      
      if (dados.nome !== nomeUsuario) {
        notificationSound.play().catch(e => {
          console.log("Autoplay do som bloqueado pelo navegador.");
        });
      }
    });

    // üîπ Atualiza lista de usu√°rios
    socket.on("usuarios", (usuarios) => {
      userList.innerHTML = "";
      usuarios.forEach((user) => {
        const div = document.createElement("div");
        div.classList.add("user");

        const fotoDiv = document.createElement("div");
        fotoDiv.classList.add("user-photo");

        if (user.foto) {
          fotoDiv.style.backgroundImage = `url('${user.foto}')`;
        } else {
          fotoDiv.textContent = user.nome.charAt(0).toUpperCase();
        }

        const nomeSpan = document.createElement("span");
        nomeSpan.textContent = user.nome;

        div.appendChild(fotoDiv);
        div.appendChild(nomeSpan);
        userList.appendChild(div);
      });
    });
  </script>
</body>
</html>